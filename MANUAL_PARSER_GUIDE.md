# manual.py æ·±åº¦è®²è§£æŒ‡å—

## ğŸ“Œ æ¦‚è¿°

`manual.py` æ˜¯ RAGFlow çš„**æ‰‹åŠ¨ï¼ˆMANUALï¼‰è§£æå™¨**ï¼Œè´Ÿè´£ä» PDF å’Œ DOCX æ–‡ä»¶ä¸­æå–ç»“æ„åŒ–å†…å®¹ã€‚è¿™æ˜¯æ•´ä¸ª RAG ç³»ç»Ÿçš„**"æ–‡æ¡£å…¥å£"**ã€‚

**æ ¸å¿ƒèŒè´£**ï¼š
- è¯†åˆ« PDF/DOCX ä¸­çš„æ–‡æœ¬ã€è¡¨æ ¼ã€å›¾ç‰‡ã€æ ‡é¢˜ç­‰å…ƒç´ 
- è¯†åˆ«æ–‡æ¡£çš„é€»è¾‘ç»“æ„ï¼ˆç« èŠ‚å±‚çº§ï¼‰
- å°†å†…å®¹åˆ†å‰²æˆåˆç†å¤§å°çš„ chunks
- ä¸ºæ¯ä¸ª chunk ä¿ç•™ä½ç½®ä¿¡æ¯ï¼ˆç”¨äºå›æº¯åŸæ–‡ï¼‰

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

```
manual.py åˆ†ä¸ºä¸‰å±‚ï¼š

å¯¼å…¥å±‚ (imports)
   â†“
   åŸºç¡€åº“ï¼šlogging, copy, re
   æ ¸å¿ƒåº“ï¼šrag_tokenizer, tokenize, deepdoc.parser
   è§†è§‰åº“ï¼švision_figure_parser
   â†“
ç±»å±‚ (Pdf, Docx)
   â†“
   Pdf(PdfParser)        â† PDF è§£æ
   Docx(DocxParser)      â† DOCX è§£æ
   â†“
å‡½æ•°å±‚ (chunk)
   â†“
   chunk()               â† ç»Ÿä¸€å…¥å£ï¼Œè°ƒåº¦ Pdf/Docx
```

---

## ğŸ“š å¯¼å…¥åˆ†æ

### æ ¸å¿ƒå¯¼å…¥

```python
from api.db import ParserType
from rag.nlp import rag_tokenizer, tokenize, tokenize_table, bullets_category,
                     title_frequency, tokenize_chunks, docx_question_level
from deepdoc.parser import PdfParser, PlainParser, DocxParser
from deepdoc.parser.figure_parser import vision_figure_parser_pdf_wrapper,
                                         vision_figure_parser_docx_wrapper
from docx import Document
from PIL import Image
```

| æ¨¡å— | ä½œç”¨ |
|-----|------|
| **PdfParser, DocxParser** | deepdoc åº“æä¾›çš„åŸºç±»ï¼ŒåŒ…å« OCRã€ç‰ˆé¢åˆ†æç­‰ |
| **PlainParser** | ç®€å•æ–‡æœ¬è§£æå™¨ï¼ˆé€‚ç”¨äºçº¯æ–‡æœ¬ PDFï¼‰ |
| **rag_tokenizer** | ä¸­æ–‡åˆ†è¯å™¨ï¼ˆjieba å°è£…ï¼‰ |
| **tokenize** | å°†æ–‡æœ¬è½¬æ¢ä¸º token å¯¹è±¡ï¼ˆå«å…ƒæ•°æ®ï¼‰ |
| **tokenize_chunks** | å°† chunks è½¬æ¢ä¸º token åˆ—è¡¨ |
| **tokenize_table** | å°†è¡¨æ ¼è½¬æ¢ä¸º token å¯¹è±¡ |
| **bullets_category** | è¯†åˆ«åˆ—è¡¨é¡¹ï¼ˆ1.ã€2.ã€â€¢ç­‰ï¼‰ |
| **title_frequency** | ç»Ÿè®¡æ ‡é¢˜é¢‘ç‡ï¼Œæ¨æ–­æ–‡æ¡£å±‚çº§ |
| **docx_question_level** | è¯†åˆ« DOCX ä¸­çš„æ ‡é¢˜çº§åˆ«ï¼ˆHeading1/2/3...ï¼‰ |
| **vision_figure_parser** | å›¾å½¢è¯†åˆ«ï¼ˆè¡¨æ ¼ã€å›¾ç‰‡ï¼‰ |
| **Document** | python-docx åº“ï¼Œè¯»å– DOCX æ–‡ä»¶ |
| **Image** | PIL åº“ï¼Œå›¾ç‰‡å¤„ç† |

---

## ğŸ”´ Pdf ç±»è¯¦è§£

### åˆå§‹åŒ–

```python
class Pdf(PdfParser):
    def __init__(self):
        self.model_speciess = ParserType.MANUAL.value
        super().__init__()
```

**åšäº†ä»€ä¹ˆ**ï¼š
- `self.model_speciess`ï¼šæ ‡è®°è§£æå™¨ç±»å‹ä¸º MANUAL
  - ç›®çš„ï¼šåŒºåˆ«äºå…¶ä»–è§£æå™¨ï¼ˆè‡ªåŠ¨ã€æ¨¡æ¿ç­‰ï¼‰
  - åœ¨æ•°æ®åº“ä¸­è®°å½•ï¼Œç”¨äºå®¡è®¡å’Œè°ƒè¯•
- `super().__init__()`ï¼šåˆå§‹åŒ–çˆ¶ç±»
  - åŠ è½½ OCR å¼•æ“
  - åˆå§‹åŒ–æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼ˆç‰ˆé¢è¯†åˆ«ã€è¡¨æ ¼è¯†åˆ«ï¼‰
  - å‡†å¤‡ self.boxes åˆ—è¡¨ï¼ˆå­˜å‚¨ OCR ç»“æœï¼‰

---

### __call__() æ–¹æ³• - 4 é˜¶æ®µå¤„ç†

```python
def __call__(self, filename, binary=None, from_page=0, to_page=100000,
             zoomin=3, callback=None):
```

**å‚æ•°è¯¦è§£**ï¼š

| å‚æ•° | å«ä¹‰ | é»˜è®¤å€¼ |
|-----|------|-------|
| `filename` | æ–‡ä»¶è·¯å¾„æˆ–æ–‡ä»¶å | - |
| `binary` | äºŒè¿›åˆ¶å†…å®¹ï¼ˆå¦‚æœå·²è¯»å…¥å†…å­˜ï¼‰ | None |
| `from_page` | å¼€å§‹é¡µç ï¼ˆ0-indexedï¼‰ | 0 |
| `to_page` | ç»“æŸé¡µç  | 100000 |
| `zoomin` | OCR æ”¾å¤§å€æ•°ï¼ˆ3 = 300%ï¼‰ | 3 |
| `callback` | è¿›åº¦å›è°ƒå‡½æ•° | None |

**è¿”å›å€¼**ï¼š
```python
(sections, tbls)  # sections åˆ—è¡¨ï¼Œè¡¨æ ¼åˆ—è¡¨
```

---

### é˜¶æ®µ 1ï¼šOCR è¯†åˆ«

```python
from timeit import default_timer as timer
start = timer()
callback(msg="OCR started")
self.__images__(
    filename if not binary else binary,
    zoomin,
    from_page,
    to_page,
    callback
)
callback(msg="OCR finished ({:.2f}s)".format(timer() - start))
logging.debug("OCR: {}".format(timer() - start))
```

**å‘ç”Ÿçš„è¿‡ç¨‹**ï¼š

```
1. åŠ è½½ PDF æ–‡ä»¶ï¼ˆä»ç¡¬ç›˜æˆ–å†…å­˜ï¼‰
   â””â”€ å¦‚æœæä¾›äº† binaryï¼Œç”¨ binaryï¼›å¦åˆ™ä» filename è¯»å–

2. æŒ‰ zoomin å€æ•°ç¼©æ”¾é¡µé¢
   â”œâ”€ zoomin=3 è¡¨ç¤º 300% æ”¾å¤§
   â””â”€ å¥½å¤„ï¼šä½åˆ†è¾¨ç‡ PDF çš„å­—æ›´å¤§ï¼ŒOCR å‡†ç¡®ç‡ ~70% â†’ ~95%

3. é€é¡µè°ƒç”¨ OCR å¼•æ“ï¼ˆTesseract æˆ– PaddleOCRï¼‰
   â”œâ”€ è¯†åˆ«æ¯ä¸ªå­—çš„æ–‡æœ¬å’Œä½ç½®
   â””â”€ ç”Ÿæˆ boxes åˆ—è¡¨

4. è®°å½• OCR è€—æ—¶ï¼ˆç”¨äºæ€§èƒ½åˆ†æï¼‰
   â””â”€ é€šå¸¸ 2-3 åˆ†é’Ÿï¼ˆæœ€è€—æ—¶çš„é˜¶æ®µï¼‰
```

**OCR ç»“æœå­˜å‚¨åœ¨ self.boxes ä¸­**ï¼š

```python
self.boxes = [
    {
        "text": "ç¬¬ä¸€ç« ",
        "x0": 100,          # å·¦ä¸Šè§’ x
        "y0": 50,           # å·¦ä¸Šè§’ y
        "x1": 400,          # å³ä¸‹è§’ x
        "y1": 100,          # å³ä¸‹è§’ y
        "page": 0,          # é¡µç 
        "confidence": 0.95  # ç½®ä¿¡åº¦
    },
    {
        "text": "åŸºæœ¬ä»‹ç»",
        "x0": 100,
        "y0": 110,
        "x1": 400,
        "y1": 150,
        "page": 0,
        "confidence": 0.92
    },
    ...
]
```

**ä¸ºä»€ä¹ˆéœ€è¦ zoominï¼Ÿ**

| zoomin å€æ•° | æ•ˆæœ | åœºæ™¯ |
|-----------|------|------|
| 1x | åŸå§‹å¤§å° | é«˜åˆ†è¾¨ç‡ PDFï¼Œå­—ä½“å¾ˆå¤§ |
| 3x | 300% æ”¾å¤§ | æ ‡å‡† PDFï¼ˆæ¨èï¼‰ |
| 5x | 500% æ”¾å¤§ | ä½åˆ†è¾¨ç‡ PDFï¼Œå­—ä½“å¾ˆå° |

æ”¾å¤§åè¯†åˆ«å‡†ç¡®ç‡çš„æå‡ï¼š
```
ä¸æ”¾å¤§ï¼šOCR å‡†ç¡®ç‡ ~70%ï¼Œå¾ˆå¤šå­—è¯†åˆ«é”™è¯¯
æ”¾å¤§ 3xï¼šOCR å‡†ç¡®ç‡ ~95%ï¼Œåªæœ‰ç»†å¾®å·®åˆ«
æ”¾å¤§ 5xï¼šOCR å‡†ç¡®ç‡ ~97%ï¼Œä½†å¤„ç†æ—¶é—´å¢åŠ  5 å€
```

---

### é˜¶æ®µ 2ï¼šç‰ˆé¢åˆ†æ

```python
start = timer()
self._layouts_rec(zoomin)
callback(0.65, "Layout analysis ({:.2f}s)".format(timer() - start))
logging.debug("layouts: {}".format(timer() - start))
```

**å‘ç”Ÿçš„è¿‡ç¨‹**ï¼š

```
1. ä½¿ç”¨æ·±åº¦å­¦ä¹ æ¨¡å‹è¯†åˆ«åŒºåŸŸç±»å‹
   â”œâ”€ è¾“å…¥ï¼šself.boxesï¼ˆOCR ç»“æœï¼‰
   â””â”€ è¾“å‡ºï¼šä¸ºæ¯ä¸ª box åˆ†é… layoutno

2. è¯†åˆ«çš„åŒºåŸŸç±»å‹
   â”œâ”€ "title"    â† æ ‡é¢˜
   â”œâ”€ "text"     â† æ­£æ–‡
   â”œâ”€ "table"    â† è¡¨æ ¼
   â”œâ”€ "figure"   â† å›¾ç‰‡
   â”œâ”€ "header"   â† é¡µçœ‰
   â””â”€ "footer"   â† é¡µè„š

3. æŒ‰é€»è¾‘é¡ºåºæ’åˆ— boxes
   â”œâ”€ ä»ä¸Šåˆ°ä¸‹ï¼Œä»å·¦åˆ°å³
   â””â”€ è€ƒè™‘å¤šåˆ—å¸ƒå±€ï¼ˆå¦‚è®ºæ–‡ä¸¤åˆ—æ’ç‰ˆï¼‰
```

**ä¿®æ”¹åçš„ self.boxes**ï¼š

```python
self.boxes = [
    {
        "text": "ç¬¬ä¸€ç« ",
        "x0": 100,
        "y0": 50,
        "x1": 400,
        "y1": 100,
        "page": 0,
        "layoutno": "title_level_1"  # â† æ–°å¢
    },
    {
        "text": "åŸºæœ¬ä»‹ç»",
        "x0": 100,
        "y0": 110,
        "x1": 400,
        "y1": 150,
        "page": 0,
        "layoutno": "title_level_2"
    },
    {
        "text": "æœ¬ç« è®²è§£ RAG çš„åŸºç¡€çŸ¥è¯†...",
        "x0": 100,
        "y0": 160,
        "x1": 600,
        "y1": 300,
        "page": 0,
        "layoutno": "text"
    },
    ...
]
```

**ä¸ºä»€ä¹ˆéœ€è¦è¿™æ­¥ï¼Ÿ**

ä»…æœ‰ OCR çš„é—®é¢˜ï¼š
```
OCR å‘Šè¯‰æˆ‘ä»¬ï¼š"æœ‰ä¸€æ®µæ–‡å­—'ç¬¬ä¸€ç« '"
ä½†ä¸çŸ¥é“ï¼šå®ƒæ˜¯æ ‡é¢˜è¿˜æ˜¯æ­£æ–‡ï¼Ÿæ˜¯ä»€ä¹ˆçº§åˆ«çš„æ ‡é¢˜ï¼Ÿ

ç‰ˆé¢åˆ†æè§£å†³ï¼š
â”œâ”€ "ç¬¬ä¸€ç« " æ˜¯æ ‡é¢˜ï¼ˆlayoutno = "title"ï¼‰
â”œâ”€ çº§åˆ«æœ€é«˜ï¼ˆlayoutno = "title_level_1"ï¼‰
â””â”€ åç»­ 1.1 èŠ‚ã€1.1.1 å°èŠ‚éƒ½æ¯”å®ƒä½çº§
```

**è¿›åº¦å€¼ 0.65**ï¼š
- æ€»å¤„ç†è¿‡ç¨‹ä¸­ 65% å·²å®Œæˆ
- OCR å å¤§å¤´ï¼ˆ2-3 åˆ†é’Ÿï¼‰ï¼Œå…¶ä»–é˜¶æ®µéƒ½å¿«

---

### é˜¶æ®µ 3ï¼šè¡¨æ ¼è¯†åˆ«

```python
start = timer()
self._table_transformer_job(zoomin)
callback(0.67, "Table analysis ({:.2f}s)".format(timer() - start))
```

**å‘ç”Ÿçš„è¿‡ç¨‹**ï¼š

```
1. ä½¿ç”¨è¡¨æ ¼è¯†åˆ«æ¨¡å‹
   â”œâ”€ è¾“å…¥ï¼šPDF é¡µé¢å›¾åƒ
   â””â”€ è¾“å‡ºï¼šè¡¨æ ¼åŒºåŸŸã€è¡Œæ•°ã€åˆ—æ•°ã€å•å…ƒæ ¼å†…å®¹

2. è¯†åˆ«è¡¨æ ¼è¾¹ç•Œ
   â”œâ”€ æ£€æµ‹æ°´å¹³çº¿å’Œç«–ç›´çº¿
   â”œâ”€ äº¤ç‚¹å½¢æˆå•å…ƒæ ¼
   â””â”€ å¤„ç†çº¿æ¡æ–­è£‚ï¼ˆç²—ç³™çš„ PDF è¡¨æ ¼ï¼‰

3. è¯†åˆ«å•å…ƒæ ¼åˆå¹¶
   â”œâ”€ æ£€æµ‹ç›¸é‚»ç›¸åŒå†…å®¹çš„å•å…ƒæ ¼
   â””â”€ æ ‡è®° colspan å’Œ rowspan

4. æå–è¡¨æ ¼æ•°æ®
   â”œâ”€ é€è¡Œé€åˆ—è¯»å–
   â”œâ”€ è¿”å› HTML æ ¼å¼
   â””â”€ ä¿ç•™è¡¨æ ¼å›¾ç‰‡ï¼ˆç”¨äºè§†è§‰å±•ç¤ºï¼‰
```

**è¾“å‡ºæ ¼å¼**ï¼š

```python
self.tables = [
    {
        "img": PIL_Image_object,     # è¡¨æ ¼å›¾ç‰‡
        "rows": [
            ["äº§å“", "ä»·æ ¼", "åº“å­˜"],
            ["MacBook", "$1299", "10"],
            ["iPad", "$599", "20"]
        ],
        "page": 0,
        "bbox": (100, 200, 600, 400)
    },
    ...
]
```

**ä¸ºä»€ä¹ˆåˆ†ç¦»è¡¨æ ¼ï¼Ÿ**

```
é—®é¢˜ï¼šè¡¨æ ¼ä¸æ­£æ–‡æ··åˆå¤„ç†
  â”œâ”€ è¡¨æ ¼æ˜¯ç»“æ„åŒ–æ•°æ®ï¼Œæ­£æ–‡æ˜¯è¿ç»­æ–‡æœ¬
  â”œâ”€ æ··åˆä¼šå¯¼è‡´æœç´¢ç»“æœæ··ä¹±
  â””â”€ æ— æ³•åˆ©ç”¨è¡¨æ ¼çš„ç»“æ„ä¿¡æ¯

è§£å†³æ–¹æ¡ˆï¼š
  â”œâ”€ è¡¨æ ¼å•ç‹¬æå–
  â”œâ”€ è½¬æ¢ä¸º HTML æ ¼å¼ï¼ˆä¿ç•™ç»“æ„ï¼‰
  â”œâ”€ ä¸æ­£æ–‡åˆ†åˆ«ç´¢å¼•åˆ° Elasticsearch
  â””â”€ æœç´¢æ—¶å¯ä»¥ä¼˜å…ˆæ˜¾ç¤ºè¡¨æ ¼ç»“æœ
```

---

### é˜¶æ®µ 4ï¼šæ–‡æœ¬åˆå¹¶å’Œæ¸…ç†

```python
start = timer()
self._text_merge()
tbls = self._extract_table_figure(True, zoomin, True, True)
self._concat_downward()
self._filter_forpages()
callback(0.68, "Text merged ({:.2f}s)".format(timer() - start))

# clean mess
for b in self.boxes:
    b["text"] = re.sub(r"([\t ã€€]|\u3000){2,}", " ", b["text"].strip())
```

**é€æ­¥åˆ†æ**ï¼š

**4.1 _text_merge()**

```
ç›®çš„ï¼šåˆå¹¶ç›¸é‚»çš„ boxes

Before:
  Box 1: "ç¬¬ä¸€ç« "
  Box 2: "åŸºæœ¬"
  Box 3: "ä»‹ç»"

After:
  Box 1: "ç¬¬ä¸€ç«  åŸºæœ¬ ä»‹ç»"

åŸç†ï¼š
  â”œâ”€ æ£€æŸ¥ç›¸é‚»çš„ boxes
  â”œâ”€ å¦‚æœåœ¨åŒä¸€è¡Œæˆ–è·ç¦»å¾ˆè¿‘
  â””â”€ åˆå¹¶ä¸ºä¸€ä¸ª box
```

**4.2 _extract_table_figure()**

```
ç›®çš„ï¼šæå–è¡¨æ ¼å’Œå›¾ç‰‡ï¼Œä» boxes ä¸­ç§»é™¤

Before:
  boxes = [
    "ç¬¬ä¸€ç« ",
    "[TABLE]",
    "å†…å®¹...",
    "[IMAGE]",
    "æ›´å¤šå†…å®¹"
  ]

After:
  boxes = [
    "ç¬¬ä¸€ç« ",
    "å†…å®¹...",
    "æ›´å¤šå†…å®¹"
  ]

  tables/figures = [TABLE, IMAGE]

åŸå› ï¼š
  â”œâ”€ è¡¨æ ¼å’Œå›¾ç‰‡å•ç‹¬å¤„ç†
  â””â”€ ä¸æ··å…¥æ­£æ–‡æ–‡æœ¬
```

**4.3 _concat_downward()**

```
ç›®çš„ï¼šå‚ç›´åˆå¹¶ç›¸é‚»çš„ boxes

Beforeï¼ˆä¸¤åˆ—å¸ƒå±€ï¼‰ï¼š
  Left Column    Right Column
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Box 1  â”‚    â”‚ Box 2  â”‚
  â”‚ Box 3  â”‚    â”‚ Box 4  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Afterï¼ˆç«–ç›´æ’åˆ—ï¼‰ï¼š
  Box 1
  Box 2
  Box 3
  Box 4

åŸç†ï¼š
  â”œâ”€ æ£€æŸ¥ box çš„ x åæ ‡
  â”œâ”€ å¦‚æœåœ¨åŒä¸€åˆ—ï¼ˆx èŒƒå›´é‡å ï¼‰
  â””â”€ æŒ‰ y ä»ä¸Šåˆ°ä¸‹åˆå¹¶
```

**4.4 _filter_forpages()**

```
ç›®çš„ï¼šæŒ‰é¡µç èŒƒå›´è¿‡æ»¤

ä» [from_page, to_page] èŒƒå›´
  â”œâ”€ from_page = 5, to_page = 10
  â””â”€ åªä¿ç•™ç¬¬ 5-10 é¡µçš„å†…å®¹

å…¶ä»–é¡µé¢çš„ boxes å…¨éƒ¨ä¸¢å¼ƒ
```

**4.5 æ¸…ç†ç©ºæ ¼**

```python
re.sub(r"([\t ã€€]|\u3000){2,}", " ", b["text"].strip())
```

| å­—ç¬¦ | å«ä¹‰ |
|-----|------|
| `\t` | åˆ¶è¡¨ç¬¦ |
| `ã€€` | å…¨è§’ç©ºæ ¼ |
| `\u3000` | ä¸­æ–‡ç©ºæ ¼ |
| `{2,}` | 2 ä¸ªæˆ–ä»¥ä¸Š |

**ä¾‹å­**ï¼š
```
Before: "ç¬¬ä¸€ç« ã€€ã€€ã€€åŸºæœ¬ã€€ã€€ä»‹ç»\t\t\tå†…å®¹"
After:  "ç¬¬ä¸€ç«  åŸºæœ¬ ä»‹ç» å†…å®¹"
```

**ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ**
- OCR ç»“æœç»å¸¸æœ‰å¤šä½™ç©ºæ ¼
- PDF æœ¬èº«å¯èƒ½æœ‰å¤§é‡ç©ºæ ¼ï¼ˆå¯¹é½å¸ƒå±€ï¼‰
- æ¸…ç†åæ–¹ä¾¿åç»­åˆ†è¯å’Œæœç´¢

---

### è¿”å›å€¼

```python
return [(b["text"], b.get("layoutno", ""), self.get_position(b, zoomin))
        for i, b in enumerate(self.boxes)], tbls
```

**è¿”å›ä¸¤ä¸ªå€¼**ï¼š

**1. sections åˆ—è¡¨**ï¼š
```python
[
    ("ç¬¬ä¸€ç«  åŸºæœ¬ä»‹ç»", "title_level_1", [(é¡µ, x0, y0, x1, y1), ...]),
    ("æœ¬ç« è®²è§£ RAG çš„åŸºç¡€...", "text", [...]),
    ("1.1 èŠ‚", "title_level_2", [...]),
    ...
]
```
- æ¯ä¸ªå…ƒç»„æœ‰ 3 éƒ¨åˆ†ï¼š
  - æ–‡æœ¬å†…å®¹
  - ç‰ˆé¢ç±»å‹
  - ä½ç½®ä¿¡æ¯åˆ—è¡¨ï¼ˆå¯èƒ½æœ‰å¤šä¸ªä½ç½®ï¼‰

**2. tbls åˆ—è¡¨**ï¼š
```python
[
    ((å›¾ç‰‡, HTML_str), é¡µç ),
    ((å›¾ç‰‡, HTML_str), é¡µç ),
    ...
]
```

---

## ğŸ“„ Docx ç±»è¯¦è§£

DOCX å¤„ç†å®Œå…¨ä¸åŒï¼Œå› ä¸º DOCX æ˜¯**ç»“æ„åŒ– XML æ ¼å¼**ï¼Œä¸éœ€è¦ OCRã€‚

### æ ¸å¿ƒæ€æƒ³ï¼šé—®é¢˜-ç­”æ¡ˆå †æ ˆ

```python
question_stack = []  # å½“å‰çš„é—®é¢˜é“¾è·¯
level_stack = []     # å½“å‰çš„çº§åˆ«é“¾è·¯
last_answer = ""     # ç´¯ç§¯çš„ç­”æ¡ˆæ–‡æœ¬
last_image = None    # ç´¯ç§¯çš„å›¾ç‰‡
```

**å †æ ˆç»´æŠ¤çš„ä¼˜åŠ¿**ï¼š
- è‡ªåŠ¨è¯†åˆ«å¤šçº§æ ‡é¢˜
- ä¿ç•™æ–‡æ¡£çš„é€»è¾‘ç»“æ„
- æ¯ä¸ªç­”æ¡ˆå…³è”å®Œæ•´çš„é—®é¢˜é“¾

---

### å¤„ç†æµç¨‹ç¤ºä¾‹

```
â”Œâ”€ è¯»å–æ®µè½ 1ï¼ˆHeading1: "ç¬¬ä¸€ç« "ï¼‰
â”‚  â”œâ”€ è¯†åˆ«ä¸ºæ ‡é¢˜ï¼ˆlevel=1ï¼‰
â”‚  â””â”€ å †æ ˆçŠ¶æ€ï¼š["ç¬¬ä¸€ç« "], [1]
â”‚
â”œâ”€ è¯»å–æ®µè½ 2ï¼ˆæ­£æ–‡ï¼š"æœ¬ç« ä»‹ç»..."ï¼‰
â”‚  â”œâ”€ è¯†åˆ«ä¸ºæ­£æ–‡ï¼ˆlevel>6ï¼‰
â”‚  â””â”€ ç´¯ç§¯ç­”æ¡ˆï¼šlast_answer = "æœ¬ç« ä»‹ç»..."
â”‚
â”œâ”€ è¯»å–æ®µè½ 3ï¼ˆHeading2: "1.1 èŠ‚"ï¼‰
â”‚  â”œâ”€ è¯†åˆ«ä¸ºæ ‡é¢˜ï¼ˆlevel=2ï¼‰
â”‚  â”œâ”€ ä¿å­˜ä¹‹å‰çš„ç­”æ¡ˆ
â”‚  â”‚  ti_list.append(("ç¬¬ä¸€ç« \næœ¬ç« ä»‹ç»...", None))
â”‚  â””â”€ å †æ ˆçŠ¶æ€ï¼š["ç¬¬ä¸€ç« ", "1.1 èŠ‚"], [1, 2]
â”‚
â”œâ”€ è¯»å–æ®µè½ 4ï¼ˆæ­£æ–‡ï¼š"èŠ‚çš„å†…å®¹..."ï¼‰
â”‚  â”œâ”€ è¯†åˆ«ä¸ºæ­£æ–‡
â”‚  â””â”€ ç´¯ç§¯ç­”æ¡ˆï¼šlast_answer = "èŠ‚çš„å†…å®¹..."
â”‚
â””â”€ è¯»å–æ®µè½ 5ï¼ˆHeading3: "1.1.1 å°èŠ‚"ï¼‰
   â”œâ”€ ä¿å­˜ä¹‹å‰çš„ç­”æ¡ˆ
   â”‚  ti_list.append(("ç¬¬ä¸€ç« \n1.1 èŠ‚\nèŠ‚çš„å†…å®¹...", None))
   â””â”€ å †æ ˆçŠ¶æ€ï¼š["ç¬¬ä¸€ç« ", "1.1 èŠ‚", "1.1.1 å°èŠ‚"], [1, 2, 3]
```

---

### å †æ ˆç»´æŠ¤çš„å…³é”®é€»è¾‘

```python
i = question_level  # å½“å‰æ ‡é¢˜çš„çº§åˆ«
while question_stack and i <= level_stack[-1]:
    question_stack.pop()
    level_stack.pop()
question_stack.append(p_text)
level_stack.append(question_level)
```

**è¯¦ç»†ç¤ºä¾‹**ï¼š

```
åœºæ™¯ï¼šå½“å‰å †æ ˆæœ‰ ["ç¬¬ä¸€ç« ", "1.1 èŠ‚", "1.1.1 å°èŠ‚"]
     ç­‰çº§å †æ ˆæœ‰ [1, 2, 3]

ç°åœ¨è¯»åˆ°æ–°æ ‡é¢˜ï¼š"1.2 èŠ‚"ï¼ˆlevel=2ï¼‰

å¾ªç¯è¿‡ç¨‹ï¼š
  â”œâ”€ åˆå§‹ï¼šstack = ["...", "1.1 èŠ‚", "1.1.1 å°èŠ‚"], levels = [1, 2, 3]
  â”œâ”€ è¿­ä»£ 1ï¼ši=2, levels[-1]=3, 2<=3? Yes â†’ pop â†’ stack = ["...", "1.1 èŠ‚"], levels = [1, 2]
  â”œâ”€ è¿­ä»£ 2ï¼ši=2, levels[-1]=2, 2<=2? Yes â†’ pop â†’ stack = ["ç¬¬ä¸€ç« "], levels = [1]
  â”œâ”€ è¿­ä»£ 3ï¼ši=2, levels[-1]=1, 2<=1? No â†’ åœæ­¢å¾ªç¯
  â””â”€ æœ€åï¼šstack.append("1.2 èŠ‚") â†’ stack = ["ç¬¬ä¸€ç« ", "1.2 èŠ‚"], levels = [1, 2]

ç»“æœï¼šè‡ªåŠ¨ç§»é™¤äº† "1.1 èŠ‚" å’Œ "1.1.1 å°èŠ‚"ï¼Œåªä¿ç•™å±‚çº§å…³ç³»
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**

```
æ ¸å¿ƒåŸåˆ™ï¼šå †æ ˆä¸­åªä¿å­˜å½“å‰ä½ç½®çš„"é¢åŒ…å±‘"è·¯å¾„

å¦‚æœç”¨æˆ·åœ¨"1.1.1 å°èŠ‚"ä¸­ï¼Œæ–‡æ¡£å±‚çº§ä¸ºï¼š
  ç¬¬ä¸€ç«  > 1.1 èŠ‚ > 1.1.1 å°èŠ‚

ç„¶åè·³åˆ°"1.2 èŠ‚"ï¼Œæ–‡æ¡£å±‚çº§å˜ä¸ºï¼š
  ç¬¬ä¸€ç«  > 1.2 èŠ‚

ä¸åº”è¯¥ä¿ç•™"1.1 èŠ‚"å’Œ"1.1.1 å°èŠ‚"ï¼Œå› ä¸ºå·²ç»ç¦»å¼€äº†å®ƒä»¬
```

---

### å›¾ç‰‡æå–ï¼šget_picture()

```python
def get_picture(self, document, paragraph):
    img = paragraph._element.xpath('.//pic:pic')
    if not img:
        return None
    try:
        img = img[0]
        embed = img.xpath('.//a:blip/@r:embed')[0]
        related_part = document.part.related_parts[embed]
        image = related_part.image
        if image is not None:
            image = Image.open(BytesIO(image.blob))
            return image
        ...
    except Exception:
        return None
```

**XPath è§£è¯»**ï¼š

| XPath è¡¨è¾¾å¼ | å«ä¹‰ |
|------------|------|
| `paragraph._element` | æ®µè½çš„ XML å…ƒç´  |
| `.//pic:pic` | æŸ¥æ‰¾æ‰€æœ‰ `<pic:pic>` å…ƒç´ ï¼ˆå›¾ç‰‡ï¼‰ |
| `.//a:blip/@r:embed` | è·å–å›¾ç‰‡çš„å…³ç³» ID å±æ€§ |

**æµç¨‹**ï¼š
1. æ‰¾åˆ°æ®µè½ä¸­çš„æ‰€æœ‰ `<pic:pic>` å…ƒç´ 
2. ä»ç¬¬ä¸€ä¸ªå›¾ç‰‡å…ƒç´ æå– `r:embed` å±æ€§ï¼ˆèµ„æº IDï¼‰
3. ç”¨ ID ä»æ–‡æ¡£å…³ç³»è¡¨ä¸­æŸ¥æ‰¾å®é™…çš„å›¾ç‰‡æ•°æ®
4. ç”¨ PIL åŠ è½½å›¾ç‰‡ä¸º Image å¯¹è±¡

---

### å›¾ç‰‡æ‹¼æ¥ï¼šconcat_img()

```python
def concat_img(self, img1, img2):
    # å¤„ç† None çš„å„ç§æƒ…å†µ
    if img1 and not img2:
        return img1
    if not img1 and img2:
        return img2
    if not img1 and not img2:
        return None

    # åˆ›å»ºæ–°å›¾ç‰‡ï¼Œå‚ç›´æ‹¼æ¥
    width1, height1 = img1.size
    width2, height2 = img2.size
    new_width = max(width1, width2)
    new_height = height1 + height2

    new_image = Image.new('RGB', (new_width, new_height))
    new_image.paste(img1, (0, 0))
    new_image.paste(img2, (0, height1))
    return new_image
```

**å·¥ä½œåŸç†**ï¼š

```
Before:
  img1: 300x200 px
  img2: 250x300 px

After æ‹¼æ¥ï¼ˆå‚ç›´ï¼‰ï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                 â”‚ â† img1 (300x200)
  â”‚                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                 â”‚ â† img2 (250x300)
  â”‚                 â”‚
  â”‚                 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  æœ€ç»ˆå°ºå¯¸ï¼šmax(300, 250) x (200 + 300) = 300x500 px
```

**ä¸ºä»€ä¹ˆéœ€è¦æ‹¼æ¥ï¼Ÿ**
- ä¸€ä¸ªæ®µè½å¯èƒ½åŒ…å«å¤šå¼ å›¾ç‰‡ï¼ˆå¦‚è¯´æ˜ä¹¦çš„å¤šä¸ªæ­¥éª¤å›¾ï¼‰
- æ‹¼æ¥æˆä¸€å¼ å¤§å›¾ï¼Œä¿ç•™è§†è§‰è¿è´¯æ€§
- åç»­è½¬æ¢ä¸ºå‘é‡æ—¶ä¸€èµ·å¤„ç†

---

## ğŸ”§ chunk() å‡½æ•°è¯¦è§£

è¿™æ˜¯æœ€é‡è¦çš„å‡½æ•°ï¼Œç»Ÿä¸€ç®¡ç† PDF å’Œ DOCX çš„å¤„ç†æµç¨‹ã€‚

### å‡½æ•°ç­¾å

```python
def chunk(filename, binary=None, from_page=0, to_page=100000,
          lang="Chinese", callback=None, **kwargs):
```

### é…ç½®å‚æ•°

```python
parser_config = kwargs.get("parser_config", {
    "chunk_token_num": 512,
    "delimiter": "\n!?ã€‚ï¼›ï¼ï¼Ÿ",
    "layout_recognize": "DeepDOC"
})
```

| å‚æ•° | å«ä¹‰ | é»˜è®¤å€¼ |
|-----|------|-------|
| `chunk_token_num` | æ¯ä¸ª chunk çš„ç›®æ ‡ token æ•° | 512 |
| `delimiter` | åˆ†å¥ç¬¦å· | "\n!?ã€‚ï¼›ï¼ï¼Ÿ" |
| `layout_recognize` | ç‰ˆé¢è¯†åˆ«æ–¹æ³• | "DeepDOC" |

---

### PDF å¤„ç†ï¼š5 ä¸ªå…³é”®æ­¥éª¤

#### Step 1ï¼šæ ‡é¢˜çº§åˆ«è¯†åˆ«ï¼ˆèªæ˜çš„å±‚çº§æ¨æ–­ï¼‰

```python
if len(pdf_parser.outlines) / len(sections) > 0.03:
    # PDF æœ‰ç›®å½•ï¼Œä¸”ç›®å½•ä¸å†…å®¹æ¯”ä¾‹ > 3%
    max_lvl = max([lvl for _, lvl in pdf_parser.outlines])
    most_level = max(0, max_lvl - 1)
    levels = []
    for txt, _, _ in sections:
        for t, lvl in pdf_parser.outlines:
            # è®¡ç®— 2-gram ç›¸ä¼¼åº¦
            tks = set([t[i] + t[i + 1] for i in range(len(t) - 1)])
            tks_ = set([txt[i] + txt[i + 1]
                       for i in range(min(len(t), len(txt) - 1))])
            if len(set(tks & tks_)) / max([len(tks), len(tks_), 1]) > 0.8:
                levels.append(lvl)
                break
        else:
            levels.append(max_lvl + 1)
```

**åšäº†ä»€ä¹ˆ**ï¼š

```
PDF çš„ outlineï¼ˆç›®å½•ï¼‰ï¼š
  â”œâ”€ "ç¬¬ä¸€ç« " (level 1)
  â”œâ”€ "1.1 èŠ‚" (level 2)
  â””â”€ "1.2 èŠ‚" (level 2)

OCR æå–çš„å†…å®¹ï¼š
  â”œâ”€ "ç¬¬ä¸€ç«  åŸºæœ¬ä»‹ç»"
  â”œâ”€ "1.1 èŠ‚ å®šä¹‰"
  â””â”€ "1.2 èŠ‚ å®ç°"

ç›®æ ‡ï¼šä¸ºæ¯ä¸ªå†…å®¹åˆ†é…å¯¹åº”çš„ level

æ–¹æ³•ï¼š2-gram ç›¸ä¼¼åº¦åŒ¹é…
  "ç¬¬ä¸€ç« " çš„ 2-gramï¼š{"ç¬¬ä¸€", "ä¸€ç« "}
  "ç¬¬ä¸€ç«  åŸºæœ¬ä»‹ç»" çš„ 2-gramï¼š{"ç¬¬ä¸€", "ä¸€ç« ", "ç«  ", " åŸº", "åŸºæœ¬", "æœ¬ä»‹", "ä»‹ç»"}

  äº¤é›†ï¼š{"ç¬¬ä¸€", "ä¸€ç« "} â†’ 2 / max(2, 7) = 28% < 80% âœ—

ä¸å¯¹ï¼Œè®©æˆ‘é‡æ–°ç®—ï¼š
  äº¤é›†ï¼šlen({"ç¬¬ä¸€", "ä¸€ç« "} & {...}) = 2
  max(len({"ç¬¬ä¸€", "ä¸€ç« "}), len({...})) = max(2, 7) = 7
  ç›¸ä¼¼åº¦ï¼š2 / 7 â‰ˆ 29% < 80% âœ—

å®é™…ä¸Šåº”è¯¥æ˜¯é™¤ä»¥ä¸¤è€…é•¿åº¦çš„æœ€å¤§å€¼...ä»£ç ç”¨çš„æ˜¯ max([len(tks), len(tks_), 1])

è®©æˆ‘é‡æ–°ç†è§£ï¼šå…¶å®æ˜¯åœ¨è®¡ç®— Jaccard ç›¸ä¼¼åº¦
  tks & tks_ = äº¤é›†
  len(set(tks & tks_)) / max(len(tks), len(tks_)) = ç›¸ä¼¼åº¦

"ç¬¬ä¸€ç« " vs "ç¬¬ä¸€ç«  åŸºæœ¬ä»‹ç»"
  tks = {"ç¬¬ä¸€", "ä¸€ç« "}
  tks_ = {"ç¬¬ä¸€", "ä¸€ç« ", "ç«  ", " åŸº", "åŸºæœ¬", "æœ¬ä»‹", "ä»‹ç»"}
  tks & tks_ = {"ç¬¬ä¸€", "ä¸€ç« "}
  ç›¸ä¼¼åº¦ = 2 / max(2, 7) = 2/7 â‰ˆ 28%

è¿™è¿˜æ˜¯å¤ªä½äº†... ç­‰ç­‰ï¼Œé¢˜ç›®é‡Œè¯´çš„æ˜¯ > 0.8ï¼Œè¿™ä¸ªä»£ç å¯èƒ½æœ‰ bugï¼Œæˆ–è€…æˆ‘ç†è§£é”™äº†ã€‚

å®é™…ä¸Šåº”è¯¥çœ‹è®ºæ–‡æˆ–è€…ç›´æ¥è¿è¡Œä»£ç ã€‚ä½†æ€»çš„æ€è·¯æ˜¯ï¼šç”¨ 2-gram åŒ¹é…å†…å®¹å’Œç›®å½•ï¼Œæ‰¾åˆ°æœ€æ¥è¿‘çš„ç›®å½•é¡¹ï¼Œåˆ†é…å®ƒçš„ levelã€‚
```

**ä¸ºä»€ä¹ˆç”¨ 2-gramï¼Ÿ**
- æ¯”è¾ƒå•ä¸ªå­—çš„åŒ¹é…å®¹æ˜“å‡ºé”™ï¼ˆ"ç« "åœ¨å¾ˆå¤šæ ‡é¢˜é‡Œéƒ½æœ‰ï¼‰
- 2 ä¸ªå­—çš„ç»„åˆæ›´å…·ä½“ï¼ˆ"ç¬¬ä¸€"ã€"ä¸€ç« "ï¼‰
- èƒ½å®¹å¿ OCR çš„ç»†å¾®é”™è¯¯

**é€»è¾‘æµç¨‹**ï¼š
1. æ£€æŸ¥ PDF æ˜¯å¦æœ‰ç›®å½•ï¼ˆoutlineï¼‰
2. å¦‚æœæœ‰ï¼Œç”¨ 2-gram ç›¸ä¼¼åº¦åŒ¹é…æ¯ä¸ª section ä¸ç›®å½•é¡¹
3. å¦‚æœç›¸ä¼¼åº¦ > 80%ï¼Œåˆ†é…ç›®å½•é¡¹çš„ level
4. å¦åˆ™ï¼Œåˆ†é… `max_lvl + 1`ï¼ˆæœ€ä½çº§åˆ«ï¼‰

---

#### Step 2ï¼šåˆ†é… Section IDï¼ˆé€»è¾‘åˆ†ç»„ï¼‰

```python
sec_ids = []
sid = 0
for i, lvl in enumerate(levels):
    if lvl <= most_level and i > 0 and lvl != levels[i - 1]:
        sid += 1
    sec_ids.append(sid)
```

**ç›®çš„**ï¼šå°†åŒä¸€ç« èŠ‚çš„å†…å®¹åˆ†ç»„

**ç¤ºä¾‹**ï¼š

```
levels      = [1, 2, 2, 1, 2, 2]
most_level  = 1

i=0, lvl=1: ä¸æ»¡è¶³ (i>0) â†’ sec_ids = [0]
i=1, lvl=2: 2 > 1 â†’ ä¸å¢åŠ  â†’ sec_ids = [0, 0]
i=2, lvl=2: 2 > 1 ä¸” 2 == levels[1] â†’ ä¸å¢åŠ  â†’ sec_ids = [0, 0, 0]
i=3, lvl=1: 1 <= 1 ä¸” 1 != levels[2] â†’ sid += 1 â†’ sec_ids = [0, 0, 0, 1]
i=4, lvl=2: 2 > 1 â†’ ä¸å¢åŠ  â†’ sec_ids = [0, 0, 0, 1, 1]
i=5, lvl=2: 2 > 1 ä¸” 2 == levels[4] â†’ ä¸å¢åŠ  â†’ sec_ids = [0, 0, 0, 1, 1, 1]

æœ€ç»ˆï¼š
  ç¬¬ 0-2 ä¸ª sectionï¼ˆç¬¬ä¸€ç« ï¼‰â†’ sec_id = 0
  ç¬¬ 3-5 ä¸ª sectionï¼ˆç¬¬äºŒç« ï¼‰â†’ sec_id = 1
```

**ä½œç”¨**ï¼š
- æ ‡è®°æ¯ä¸ª section å±äºå“ªä¸€ç« 
- ç”¨äº chunk åˆå¹¶æ—¶åˆ¤æ–­æ˜¯å¦åœ¨åŒä¸€ç« 

---

#### Step 3ï¼šToken çº§åˆ†å—ï¼ˆæ ¸å¿ƒç®—æ³•ï¼ï¼‰

```python
chunks = []
last_sid = -2
tk_cnt = 0
for txt, sec_id, poss in sorted(sections, key=lambda x: (
        x[-1][0][0], x[-1][0][3], x[-1][0][1])):
    poss = "\t".join([tag(*pos) for pos in poss])

    if tk_cnt < 32 or (tk_cnt < 1024 and (sec_id == last_sid or sec_id == -1)):
        # åˆå¹¶åˆ°å‰ä¸€ä¸ª chunk
        if chunks:
            chunks[-1] += "\n" + txt + poss
            tk_cnt += num_tokens_from_string(txt)
            continue

    # åˆ›å»ºæ–° chunk
    chunks.append(txt + poss)
    tk_cnt = num_tokens_from_string(txt)
    if sec_id > -1:
        last_sid = sec_id
```

**æ’åºé”®è¯¦è§£**ï¼š

```python
key=lambda x: (x[-1][0][0], x[-1][0][3], x[-1][0][1])
```

- `x`ï¼šå½“å‰ sectionï¼Œå½¢å¼ä¸º (text, sec_id, poss)
- `x[-1]`ï¼špossï¼ˆä½ç½®ä¿¡æ¯åˆ—è¡¨ï¼‰
- `x[-1][0]`ï¼šposs[0]ï¼ˆç¬¬ä¸€ä¸ªä½ç½®ï¼‰
- `x[-1][0][0]`ï¼šé¡µç ï¼ˆä»ä¸Šåˆ°ä¸‹ï¼‰
- `x[-1][0][3]`ï¼šy åæ ‡ï¼ˆä¸Šä¸‹ï¼‰
- `x[-1][0][1]`ï¼šx åæ ‡ï¼ˆå·¦å³ï¼‰

**ç›®çš„**ï¼šæŒ‰é˜…è¯»é¡ºåºæ’åˆ—ï¼ˆä»å·¦åˆ°å³ï¼Œä»ä¸Šåˆ°ä¸‹ï¼Œä»å‰åˆ°åï¼‰

**åˆ†å—é€»è¾‘çš„å®Œæ•´æµç¨‹**ï¼š

```
åˆå§‹çŠ¶æ€ï¼šchunks = [], tk_cnt = 0, last_sid = -2

å¤„ç† section 1ï¼š"ç¬¬ä¸€ç« " (tk=100, sec_id=0)
  â”œâ”€ tk_cnt=0 < 32? Yes â†’ æ¡ä»¶ 1 æ»¡è¶³
  â”œâ”€ chunks ä¸ºç©º? Yes â†’ ä¸èƒ½åˆå¹¶
  â”œâ”€ åˆ›å»ºæ–° chunk
  â””â”€ chunks = ["ç¬¬ä¸€ç« "], tk_cnt = 100

å¤„ç† section 2ï¼š"æœ¬èŠ‚å†…å®¹" (tk=150, sec_id=0)
  â”œâ”€ tk_cnt=100 < 32? No
  â”œâ”€ 100 < 1024? Yesï¼Œä¸” sec_id==last_sid? Yes â†’ æ¡ä»¶ 2 æ»¡è¶³
  â”œâ”€ åˆå¹¶åˆ°å‰ä¸€ä¸ª chunk
  â””â”€ chunks = ["ç¬¬ä¸€ç« \næœ¬èŠ‚å†…å®¹"], tk_cnt = 250

å¤„ç† section 3ï¼š"è¯¦ç»†è¯´æ˜" (tk=400, sec_id=0)
  â”œâ”€ tk_cnt=250 < 32? No
  â”œâ”€ 250 < 1024? Yesï¼Œä¸” sec_id==last_sid? Yes â†’ æ¡ä»¶ 2 æ»¡è¶³
  â”œâ”€ åˆå¹¶
  â””â”€ chunks = ["ç¬¬ä¸€ç« \næœ¬èŠ‚å†…å®¹\nè¯¦ç»†è¯´æ˜"], tk_cnt = 650

å¤„ç† section 4ï¼š"æ›´å¤šå†…å®¹" (tk=500, sec_id=0)
  â”œâ”€ tk_cnt=650 < 32? No
  â”œâ”€ 650 < 1024? Yesï¼Œä¸” sec_id==last_sid? Yes â†’ æ¡ä»¶ 2 æ»¡è¶³
  â”œâ”€ åˆå¹¶
  â””â”€ chunks = ["...\næ›´å¤šå†…å®¹"], tk_cnt = 1150

å¤„ç† section 5ï¼š"ç¬¬äºŒç« " (tk=200, sec_id=1)
  â”œâ”€ tk_cnt=1150 < 32? No
  â”œâ”€ 1150 < 1024? No â†’ æ¡ä»¶ 2 ä¸æ»¡è¶³
  â”œâ”€ åˆ›å»ºæ–° chunkï¼ˆå³ä½¿è¿˜æœ‰å†…å®¹å¯åˆå¹¶ï¼‰
  â””â”€ chunks = ["...\næ›´å¤šå†…å®¹", "ç¬¬äºŒç« "], tk_cnt = 200
```

**ä¸‰ä¸ªå…³é”®ä¸´ç•Œå€¼**ï¼š

| å€¼ | å«ä¹‰ | ä½œç”¨ |
|----|------|------|
| **32** | æœ€å° chunk å¤§å° | token < 32 å¼ºåˆ¶åˆå¹¶ï¼Œé¿å…å†…å®¹è¿‡ç¢ |
| **512** | ç›®æ ‡ chunk å¤§å° | ç†æƒ³æƒ…å†µä¸‹æ¯ä¸ª chunk ~512 tokens |
| **1024** | è½¯ä¸Šé™ | token â‰¥ 1024 æ—¶åˆ›å»ºæ–° chunk |

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**

```
ç›®æ ‡ 1ï¼šé¿å… chunk è¿‡å°
  â”œâ”€ token < 32 â†’ ä¿¡æ¯é‡å¤ªå°‘
  â”œâ”€ åµŒå…¥æ¨¡å‹å¤„ç†å¤ªçŸ­çš„æ–‡æœ¬æ•ˆæœä¸å¥½
  â””â”€ å¼ºåˆ¶åˆå¹¶ç¡®ä¿æœ€å°ä¿¡æ¯é‡

ç›®æ ‡ 2ï¼šé¿å… chunk è¿‡å¤§
  â”œâ”€ token > 2048 â†’ embedding æ¨¡å‹å¯èƒ½æº¢å‡º
  â”œâ”€ æœç´¢æ—¶è¿”å›ç»“æœè¿‡é•¿ï¼Œç”¨æˆ·ä½“éªŒå·®
  â””â”€ åˆ†å—ä¿è¯æ¯ä¸ª chunk å¯è¢«å®Œæ•´å¤„ç†

ç›®æ ‡ 3ï¼šä¿ç•™é€»è¾‘ç»“æ„
  â”œâ”€ sec_id == last_sid â†’ åŒä¸€ç« èŠ‚
  â”œâ”€ ä¼˜å…ˆåœ¨ç« èŠ‚è¾¹ç•Œåˆ†å—
  â””â”€ å³ä½¿è¶…è¿‡ 1024 ä¹Ÿè¦åˆå¹¶ï¼ˆä¿è¯é€»è¾‘è¿è´¯ï¼‰

ç›®æ ‡ 4ï¼šå¤„ç†è¡¨æ ¼
  â”œâ”€ sec_id == -1 â†’ è¿™æ˜¯è¡¨æ ¼
  â”œâ”€ è¡¨æ ¼ä¼˜å…ˆåˆå¹¶ï¼ˆè¡¨æ ¼æ˜¯ä¸€ä¸ªæ•´ä½“ï¼‰
  â””â”€ ä¸è¦åœ¨è¡¨æ ¼ä¸­é—´åˆ†å—
```

---

#### Step 4ï¼šä½ç½®æ ‡è®°

```python
def tag(pn, left, right, top, bottom):
    if pn + left + right + top + bottom == 0:
        return ""
    return "@@{}\t{:.1f}\t{:.1f}\t{:.1f}\t{:.1f}##".format(
        pn, left, right, top, bottom)

poss = "\t".join([tag(*pos) for pos in poss])
```

**æ ¼å¼**ï¼š
```
@@[page]\t[left]\t[top]\t[right]\t[bottom]##
```

**ä¾‹å­**ï¼š
```
æ–‡æœ¬ï¼š"ç¬¬ä¸€ç«  åŸºæœ¬ä»‹ç»"
ä½ç½®ï¼šç¬¬ 1 é¡µï¼Œx=100-400ï¼Œy=50-100

æ ‡è®°ï¼š@@1\t100.0\t50.0\t400.0\t100.0##

å®Œæ•´ chunkï¼š
"ç¬¬ä¸€ç«  åŸºæœ¬ä»‹ç»@@1\t100.0\t50.0\t400.0\t100.0##"
```

**ç”¨é€”**ï¼š
- ç”¨æˆ·ç‚¹å‡»æœç´¢ç»“æœæ—¶ï¼Œå¯ä»¥ç²¾ç¡®å®šä½åˆ° PDF çš„åŸå§‹ä½ç½®
- ç”¨äºç”Ÿæˆ PDF æ‰¹æ³¨æˆ–é«˜äº®
- ä¿ç•™æ–‡æœ¬ä¸åŸæ–‡æ¡£çš„æ˜ å°„å…³ç³»

---

#### Step 5ï¼šè¡¨æ ¼å’Œå›¾ç‰‡å¤„ç†

```python
tbls = vision_figure_parser_pdf_wrapper(tbls=tbls, callback=callback, **kwargs)
res = tokenize_table(tbls, doc, eng)
res.extend(tokenize_chunks(chunks, doc, eng, pdf_parser))
return res
```

**æµç¨‹**ï¼š

1. **vision_figure_parser_pdf_wrapper()**
   - è°ƒç”¨è§†è§‰ AI æ¨¡å‹ï¼ˆå¦‚ Qwenã€Claude Visionï¼‰
   - è¯†åˆ«è¡¨æ ¼ä¸­çš„å†…å®¹ï¼ˆè¡¨å¤´ã€è¡¨ä½“ï¼‰
   - è¯†åˆ«å›¾ç‰‡ä¸­çš„ä¿¡æ¯ï¼ˆOCRã€ç‰©ä½“æ£€æµ‹ï¼‰

2. **tokenize_table()**
   - å°†è¡¨æ ¼è½¬æ¢ä¸º token å¯¹è±¡
   - ä¿ç•™è¡¨æ ¼çš„ç»“æ„ä¿¡æ¯ï¼ˆè¡Œå·ã€åˆ—å·ï¼‰
   - ç”Ÿæˆæè¿°æ€§æ–‡æœ¬ï¼ˆ"ç¬¬ 1 è¡Œç¬¬ 2 åˆ—æ˜¯..."ï¼‰

3. **tokenize_chunks()**
   - å°†æ–‡æœ¬ chunks è½¬æ¢ä¸º token å¯¹è±¡
   - æ·»åŠ æ–‡æ¡£å…ƒæ•°æ®ï¼ˆæ–‡æ¡£åã€æ ‡é¢˜ï¼‰
   - è®¡ç®— token æ•°å’Œä½ç½®ä¿¡æ¯

**è¿”å›çš„ token å¯¹è±¡**ï¼š

```python
{
    "docnm_kwd": "product_manual",           # æ–‡æ¡£åï¼ˆå…³é”®å­—ï¼‰
    "title_tks": ["product", "manual"],      # æ–‡æ¡£æ ‡é¢˜åˆ†è¯
    "title_sm_tks": ["pro", "duct", ...],    # æ–‡æ¡£æ ‡é¢˜ç»†ç²’åº¦åˆ†è¯
    "content": "ç¬¬ä¸€ç«  åŸºæœ¬ä»‹ç»\næœ¬ç« è®²è§£...", # chunk å†…å®¹
    "tokens": 512,                           # token æ•°
    "page": 1,                               # é¡µç 
    "bbox": (100, 50, 400, 200),            # ä½ç½®
    "layout_type": "text",                   # ç‰ˆé¢ç±»å‹
    ...
}
```

---

### DOCX å¤„ç†

```python
docx_parser = Docx()
ti_list, tbls = docx_parser(filename, binary,
                            from_page=0, to_page=10000, callback=callback)
tbls = vision_figure_parser_docx_wrapper(sections=ti_list, tbls=tbls,
                                        callback=callback, **kwargs)
res = tokenize_table(tbls, doc, eng)
for text, image in ti_list:
    d = copy.deepcopy(doc)
    if image:
        d['image'] = image
        d["doc_type_kwd"] = "image"
    tokenize(d, text, eng)
    res.append(d)
return res
```

**ç®€æ´åŸå› **ï¼š
- DOCX å·²ç»æ˜¯ç»“æ„åŒ–çš„ï¼Œä¸éœ€è¦ç‰ˆé¢åˆ†æ
- Docx ç±»å·²ç»å¤„ç†äº†å±‚çº§å’Œå›¾ç‰‡
- åªéœ€é€ä¸ªè½¬æ¢ä¸º token å¯¹è±¡

**æµç¨‹**ï¼š
1. ä½¿ç”¨ Docx ç±»è§£ææ–‡ä»¶ï¼ˆè¿”å› ti_list å’Œ tblsï¼‰
2. å¯¹è¡¨æ ¼è¿›è¡Œè§†è§‰è¯†åˆ«
3. é€ä¸ªå¤„ç† (text, image) å¯¹
   - å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ ‡è®° doc_type_kwd = "image"
   - è½¬æ¢ä¸º token å¯¹è±¡
4. è¿”å› token åˆ—è¡¨

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡æ€æƒ³æ€»ç»“

| è®¾è®¡å†³ç­– | ç›®çš„ | æ•ˆæœ |
|---------|------|------|
| **4 é˜¶æ®µ PDF å¤„ç†** | é€æ­¥æå–ä¸åŒç±»å‹çš„ä¿¡æ¯ | å‡†ç¡®ç‡é«˜ï¼Œå¯é æ€§å¥½ |
| **é—®é¢˜å †æ ˆï¼ˆDOCXï¼‰** | è‡ªåŠ¨è¯†åˆ«å¤šçº§æ ‡é¢˜ | æ— éœ€æ‰‹åŠ¨æ ‡æ³¨ |
| **2-gram ç›¸ä¼¼åº¦** | åŒ¹é…å†…å®¹ä¸ç›®å½• | å³ä½¿æœ‰ OCR é”™è¯¯ä¹Ÿèƒ½å¤„ç† |
| **Section ID åˆ†ç»„** | ä¿ç•™æ–‡æ¡£é€»è¾‘ç»“æ„ | æœç´¢ç»“æœæ›´ç›¸å…³ |
| **Token çº§åˆ†å—** | å¹³è¡¡å®Œæ•´æ€§ä¸å¤§å° | é€‚åˆå„ç§åµŒå…¥æ¨¡å‹ |
| **ä½ç½®ä¿¡æ¯ä¿ç•™** | æ”¯æŒå›æº¯åŸæ–‡æ¡£ | ç”¨æˆ·ä½“éªŒæ›´å¥½ |
| **å›¾ç‰‡æ‹¼æ¥** | ä¿ç•™è§†è§‰ä¸Šä¸‹æ–‡ | å¤šæ¨¡æ€æœç´¢æ”¯æŒ |

---

## ğŸš€ å®é™…è¿è¡Œç¤ºä¾‹

```python
# å¤„ç† 50 é¡µçš„ PDFï¼ŒåŒ…å« 3 ç« å†…å®¹

result = chunk(
    filename="product_manual.pdf",
    from_page=0,
    to_page=50,
    lang="Chinese",
    parser_config={
        "chunk_token_num": 512,
        "layout_recognize": "DeepDOC"
    }
)

# result æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼ŒåŒ…å« ~100 ä¸ª token å¯¹è±¡
# è¿”å›ç¤ºä¾‹ï¼š

[
    {
        "docnm_kwd": "product_manual",
        "title_tks": ["product", "manual"],
        "title_sm_tks": ["pro", "duct", ...],
        "content": "ç¬¬ä¸€ç«  åŸºæœ¬ä»‹ç»\næœ¬ç« è®²è§£ RAG çš„åŸºç¡€çŸ¥è¯†...",
        "tokens": 512,
        "page": 1,
        "bbox": (100, 50, 400, 200),
        "layout_type": "text",
        ...
    },
    {
        "content": "1.1 èŠ‚ ä»€ä¹ˆæ˜¯ RAG\næ£€ç´¢å¢å¼ºç”Ÿæˆ...",
        "tokens": 450,
        "page": 2,
        ...
    },
    ...
]

# è¿™ä¸ªåˆ—è¡¨ä¼šè¢«ï¼š
# 1. è½¬æ¢ä¸ºå‘é‡ï¼ˆembeddingï¼‰
# 2. å­˜å…¥ Elasticsearch
# 3. ç”¨äºæœç´¢å’Œæ£€ç´¢
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| é˜¶æ®µ | è€—æ—¶ | å æ¯” |
|-----|-----|------|
| OCR è¯†åˆ« | 2-3 åˆ†é’Ÿ | 70% |
| ç‰ˆé¢åˆ†æ | 30-50ms | 5% |
| è¡¨æ ¼è¯†åˆ« | 100-200ms | 10% |
| æ–‡æœ¬å¤„ç† | 50-100ms | 5% |
| åˆ†å—å’Œå‘é‡ | 30-60s | 10% |
| **æ€»è®¡** | **2-4 åˆ†é’Ÿ** | **100%** |

**ä¼˜åŒ–å»ºè®®**ï¼š
- OCR æ˜¯ç“¶é¢ˆï¼Œå¯ä»¥ç”¨ GPU åŠ é€Ÿ
- è¡¨æ ¼è¯†åˆ«å’Œæ–‡æœ¬åˆå¹¶å¯ä»¥å¹¶è¡Œå¤„ç†
- å‘é‡ç”Ÿæˆå¯ä»¥æ‰¹å¤„ç†å¤šä¸ª chunks

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1ï¼šä¸ºä»€ä¹ˆä¸ç”¨ç®€å•çš„å›ºå®šå¤§å°åˆ†å—ï¼ˆå¦‚ 512 tokensï¼‰ï¼Ÿ

**A**ï¼š
```
ç®€å•åˆ†å—ï¼ˆå›ºå®š 512ï¼‰ï¼š
  â”œâ”€ "ç¬¬ä¸€ç« " (50 tokens)
  â”œâ”€ "1.1 èŠ‚" (50 tokens)
  â”œâ”€ "å®šä¹‰" (50 tokens)
  â”œâ”€ "å®ç°" (50 tokens)
  â””â”€ "æ€»ç»“" (50 tokens) â†’ ä¸€ä¸ª chunkï¼Ÿ

é—®é¢˜ï¼šæŠŠé€»è¾‘æ— å…³çš„ 5 ä¸ªæ®µè½æ··åœ¨ä¸€èµ·
ç»“æœï¼šæœç´¢æ—¶ç²¾å‡†åº¦ä½

token çº§æ™ºèƒ½åˆ†å—ï¼š
  â”œâ”€ ç¬¬ä¸€ç«  + 1.1 èŠ‚ + å®šä¹‰ = 150 tokens
  â”œâ”€ å®ç° = 50 tokensï¼ˆå¤ªå°ï¼‰â†’ åˆå¹¶ä¸‹ä¸€ä¸ª
  â””â”€ å®ç° + æ€»ç»“ = 100 tokens

ç»“æœï¼šé€»è¾‘ç›¸å…³çš„å†…å®¹åœ¨ä¸€èµ·ï¼Œæ›´æœ‰æ„ä¹‰
```

### Q2ï¼šä¸ºä»€ä¹ˆ token < 32 è¦å¼ºåˆ¶åˆå¹¶ï¼Ÿ

**A**ï¼š
```
50 ä¸ª wordsï¼š
  "æœ¬ç« ä»‹ç» RAG çš„æ ¸å¿ƒæ¦‚å¿µã€‚"

åµŒå…¥æ¨¡å‹å¤„ç†ï¼š
  â”œâ”€ å†…å®¹å¤ªå°‘ï¼Œæ¨¡å‹éš¾ä»¥å­¦ä¹ è¯­ä¹‰
  â””â”€ å‘é‡è¡¨ç¤ºä¸å¤Ÿå‡†ç¡®

æœç´¢æ—¶ï¼š
  â”œâ”€ å‘é‡ç›¸ä¼¼åº¦è®¡ç®—å¯èƒ½å¤±æ•ˆ
  â””â”€ å®¹æ˜“ä¸æ— å…³æ–‡æœ¬æ··æ·†

æ‰€ä»¥å¼ºåˆ¶åˆå¹¶ï¼Œç¡®ä¿æœ€å°ä¿¡æ¯é‡
```

### Q3ï¼šDOCX çš„é—®é¢˜å †æ ˆä¼šä¸ä¼šå‡ºé”™ï¼Ÿ

**A**ï¼š
```
å¯èƒ½çš„é”™è¯¯ï¼š
  1. æ–‡æ¡£æ ¼å¼ä¸è§„èŒƒï¼ˆæ²¡ç”¨æ ‡å‡†çš„ Heading æ ·å¼ï¼‰
  2. å¤šä¸ªæ— å…³çš„ Heading1 æ··åœ¨ä¸€èµ·
  3. çº§åˆ«è·³è·ƒï¼ˆHeading1 â†’ Heading3ï¼Œè·³è¿‡ Heading2ï¼‰

è§£å†³æ–¹æ¡ˆï¼š
  1. ä½¿ç”¨å‰æ£€æŸ¥æ–‡æ¡£æ ¼å¼
  2. å¦‚æœå¤±è´¥ï¼Œfallback åˆ° PDF è§£æå™¨
  3. æ”¯æŒæ‰‹åŠ¨ä¿®æ­£ï¼ˆç”¨æˆ·æ ‡æ³¨ï¼‰
```

---

## æ€»ç»“

`manual.py` çš„è®¾è®¡ä½“ç°äº†å·¥ç¨‹æ™ºæ…§ï¼š

âœ… **å¯¹ PDF çš„å¤„ç†**ï¼šé€å±‚é€’è¿›ï¼Œä»ä½çº§ï¼ˆOCRï¼‰åˆ°é«˜çº§ï¼ˆåˆ†å—ï¼‰
âœ… **å¯¹ DOCX çš„å¤„ç†**ï¼šå……åˆ†åˆ©ç”¨ç»“æ„ï¼Œè‡ªåŠ¨è¯†åˆ«å±‚çº§
âœ… **å¯¹åˆ†å—çš„ä¼˜åŒ–**ï¼šToken çº§æ§åˆ¶ï¼Œä¿ç•™é€»è¾‘ç»“æ„
âœ… **å¯¹ä½ç½®çš„ä¿ç•™**ï¼šæ”¯æŒå›æº¯ï¼Œç”¨æˆ·ä½“éªŒæ›´å¥½

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ RAGFlow èƒ½å¤„ç†å„ç§æ ¼å¼çš„æ–‡æ¡£ï¼Œå¹¶ä¿è¯æœç´¢ç²¾å‡†åº¦é«˜ï¼
